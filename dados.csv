#!/usr/bin/env python3
"""
upload_csv.py

Uploader robusto de CSV para um endpoint HTTP (POST).
Recursos:
- detecta encoding (utf-8-sig, fallback latin-1)
- detecta delimitador via csv.Sniffer
- valida headers mínimos configuráveis
- mapeamento de colunas (header mapping)
- modo dry-run (apenas valida e mostra estatísticas)
- envia em lotes (batch) com retries exponenciais
- registra linhas com erro em errors_<timestamp>.csv
- suporta deduplicação por chave única (colunas configuráveis)
- usa Session + HTTPAdapter com Retry
"""

import argparse
import csv
import json
import time
import hashlib
from pathlib import Path
from typing import List, Dict, Tuple, Optional
import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry
from concurrent.futures import ThreadPoolExecutor, as_completed

# ---------- Configurações padrão ----------
DEFAULT_ENDPOINT = "http://127.0.0.1:8000/api/scores/"  # ajuste
DEFAULT_BATCH = 50
DEFAULT_TIMEOUT = 10
DEFAULT_WORKERS = 4
RETRIES = 3
BACKOFF_FACTOR = 0.8

# ---------- Utilitárias ----------
def detect_encoding_and_delimiter(path: Path) -> Tuple[str, str]:
    """Tenta abrir com utf-8-sig, senão latin1; detecta delimitador com csv.Sniffer."""
    text = None
    for enc in ("utf-8-sig", "utf-8", "latin-1